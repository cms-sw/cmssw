Building format_HcalInterpolatedPulseMap helper executable
----------------------------------------------------------

The program "format_HcalInterpolatedPulseMap" converts
"HcalInterpolatedPulseMap" configuration object between a simple
text representation and a boost archive suitable for subsequent
writing in an sql database file.

To compile this program, set up the CMSSW environment, check out
CondTools/Hcal package, and build it.

Note that the executable will be placed in your directory
$CMSSW_BASE/test/$SCRAM_ARCH. For the time you are working with this
program, I suggest adding this directory to your PATH environment.
In csh-like shell you can do the following (of course, assuming that
your CMSSW environment is already set up):

setenv PATH $CMSSW_BASE/test/${SCRAM_ARCH}:$PATH
rehash


HcalInterpolatedPulseMap text format
------------------------------------

The text representation is functionally defined by the "readFromTxt"
method of the HcalInterpolatedPulseMap class. Pulse shapes are
stored one per line. Each pulse shape line is supposed to contain
a label and a set of numbers, as below:

label t_start t_end p0 p1 ...

"label" is an arbitrary string which must not contain white space.
Labels must be coordinated with the table of pulse shape delays (this
is a separate table, with labels and delays specified per channel).

"t_start" is the pulse start time, in ns.

"t_end" is the pulse end time, in ns. The pulse is assumed to be 0
before the start time and after the end time.

p0, p1, ..., pk, ... are the pulse heights, given at equidistant
time intervals. Between the specified values, pulses are interpolated
linearly. Pulse height p0 corresponds to time "t_start" and the last
pulse height specified corresponds to time "t_end". The number of
pulse heights provided should be at least 2 and should not exceed
HcalInterpolatedPulse::maxlen (currently 1500).

Lines which start with # (possibly after some white space) are ignored
(treated as comments), as well as lines that consist of white space only.

An arbitrary positive number of pulse shapes can be defined in such a file.
It is expected that these shapes will be generated by an analysis script
and that pulse shape visualization facilities will be external.


Making the boost binary file
----------------------------

Run "format_HcalInterpolatedPulseMap" executable without any command
line arguments to see its usage instructions. You can convert a simple
text representation of your pulse shapes into a boost binary file by
running

format_HcalInterpolatedPulseMap inputfile.txt archive.bbin

You can also convert the boost binary file back into text as follows:

format_HcalInterpolatedPulseMap -a archive.bbin outputfile.txt

Note that the files "inputfile.txt" and "outputfile.txt" are not
necessarily going to be identical because double precision numbers
in them do not have to be formatted in the same manner. If you want
to test that binary <-> text conversion is performed without loss
of information, you can instead do the following:

format_HcalInterpolatedPulseMap -p 8 inputfile.txt formatted.txt

This will write out a simple text file using 8 significant digits
for doubles.

format_HcalInterpolatedPulseMap formatted.txt archive.bbin
format_HcalInterpolatedPulseMap -a -p 8 archive.bbin formattedout.txt

Now, the files "formatted.txt" and "formattedout.txt" should be
identical.


Making the private database file
--------------------------------

In order to upload the HcalInterpolatedPulseMap configuration to the
CMS database, you need to create a private mysql database file first.

Edit the file "HcalInterpolatedPulseMapDBWriter_cfg.py" so that the
"inputfile" variable at the beginning of that file points to the boost
binary file you created and verified in the previous step. Also edit
"database" and "tag" variables as desired. Then run

cd $CMSSW_BASE/src/CondTools/Hcal/test
cmsRun HcalInterpolatedPulseMapDBWriter_cfg.py

This will create the database file (with the name specified by the
"database" variable) which will contain HcalInterpolatedPulseMap
configuration.

You should verify that the private .db file you created contains
a valid record by modifying "HcalInterpolatedPulseMapDBReader_cfg.py"
appropriately (in particular, variables "database", "tag", and
"outputfile" at the beginning of the file) and then running

cmsRun HcalInterpolatedPulseMapDBReader_cfg.py

The binary file written out by the database reader should be
exactly the same as the original binary file written out by
"format_HcalInterpolatedPulseMap" (you can simply "diff" these files).


Uploading the data to the CMS database
--------------------------------------

The instructions can be found in file "readme_HFPhase1PMTParams.txt",
inside identically named section. Note that HcalInterpolatedPulseMap
objects should be accompanied by HcalPulseDelays tables (these are
written using the standard HCAL ASCII database I/O methods).
