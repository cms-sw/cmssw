#!/usr/bin/env perl

use strict "vars";
use vars qw( %opts );
use vars qw( %config );

use Getopt::Long;

Getopt::Long::config('bundling_override');
%opts = ();
GetOptions( \%opts,
                "run|r=s"
);

my $runnum = $opts{'run'} || usage();

use File::Basename;

unshift(@INC, dirname($0));
require "ec_mon_utils.pl";

ec_mon_conf_file();

exit 1 unless ( -e "$config{'ec_mon_master_rundir'}/dqm-data/status/.$runnum.daq_done" );

my ($loc, $num, $lun, $out, $fun, $fil, $ful, $typ) = split('\.', "$runnum");

my $runfil = "$loc.$num.$lun.$out.$fun.$fil.$ful";

my @filelist = split('\n', `find $config{'ec_mon_master_rundir'}/daq-data/ \\( -name 'ecal_local.$num.*.A.$fun.*.*.dat' -or -name 'Global*.$num.*.A.$fun.*.*.dat' -or -name '*MW*.$num.*.A.$fun.*.*.dat' -or -name 'PrivCal*.$num.*.A.$fun.*.*.dat' -or -name 'TransferTestWithSafety.$num.*.A.$fun.*.*.dat' -or -name 'CRUZET*.$num.*.A.$fun.*.*.dat' -or -name 'CRAFT*.$num.*.A.$fun.*.*.dat' -or -name 'Commissioning*.$num.*.A.$fun.*.*.dat' -or -name 'Run*.$num.*.A.$fun.*.*.dat' -or -name 'Data.$num.*.A.$fun.*.*.dat' -or -name 'Minidaq.$num.*.A.$fun.*.*.dat' -or -name 'PrivMinidaq.$num.*.A.$fun.*.*.dat' \\) -printf '%f\n' -maxdepth 1 | sort`);

my @filelist_archived = split('\n', `find $config{'ec_mon_master_rundir'}/daq-data/trash/ \\( -name 'ecal_local.$num.*.A.$fun.*.*.dat' -or -name 'Global*.$num.*.A.$fun.*.*.dat' -or -name '*MW*.$num.*.A.$fun.*.*.dat' -or -name 'PrivCal*.$num.*.A.$fun.*.*.dat' -or -name 'TransferTestWithSafety.$num.*.A.$fun.*.*.dat' -or -name 'CRUZET*.$num.*.A.$fun.*.*.dat' -or -name 'CRAFT*.$num.*.A.$fun.*.*.dat' -or -name 'Commissioning*.$num.*.A.$fun.*.*.dat' -or -name 'Run*.$num.*.A.$fun.*.*.dat' -or -name 'Data.$num.*.A.$fun.*.*.dat' -or -name 'Minidaq.$num.*.A.$fun.*.*.dat' -or -name 'PrivMinidaq.$num.*.A.$fun.*.*.dat' \\) -printf '%f\n' -maxdepth 1 | sort`);

if ( $runnum ) {
  exit 1 unless ( @filelist != 0 ||
                  @filelist_archived != 0 );
}

system("mv -f $config{'ec_mon_master_rundir'}/dqm-data/status/.$runnum.daq_done $config{'ec_mon_master_rundir'}/dqm-data/status/.$runnum.mon_run");

if ( system("$config{'ec_mon_path'}/ec_mon_cmssw_task_wrapper --run $runfil 2>&1") || system("$config{'ec_mon_path'}/ec_mon_cmssw_task_wrapper_pedestal-offset --run $runfil 2>&1") ) {
  system("mv -f $config{'ec_mon_master_rundir'}/dqm-data/status/.$runnum.mon_run $config{'ec_mon_master_rundir'}/dqm-data/status/.$runnum.mon_fail");
  system("/nfshome0/ecalpro/DAQ/RunTime/common/pilot/scripts/notifyRCMS.pl $num FAIL >/tmp/notifyRCMS.log 2>&1");
} else {
  system("mv -f $config{'ec_mon_master_rundir'}/dqm-data/status/.$runnum.mon_run $config{'ec_mon_master_rundir'}/dqm-data/status/.$runnum.mon_done");
  system("/nfshome0/ecalpro/DAQ/RunTime/common/pilot/scripts/notifyRCMS.pl $num DONE >/tmp/notifyRCMS.log 2>&1");
}

exit 0;

############################################################################

sub usage {
  print "\nthe option --run <run_number> is mandatory !\n\n";
  exit;
}
